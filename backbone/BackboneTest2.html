<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
	<script src="//cdn.bootcss.com/underscore.js/1.8.3/underscore-min.js"></script>
	<script src="//cdn.bootcss.com/backbone.js/1.2.1/backbone-min.js"></script>
</head>
<body>
	<div></div>
	<a href="#apples/fuji">fuji</a>
</body>
<script>
	//简单示例
//	var app;
//	var router = Backbone.Router.extend({
//		routes:{"":"home"},
//		initialize:function(){
//			this.homeView = new homeView();
//			this.homeView.render();
//		}
//	});
//	var homeView = Backbone.View.extend({
//		el:"body",
//		template:_.template("hello world!"),
//		render:function(){
//			this.$el.html(this.template({}));
//		}
//	});
//	$(document).ready(function(){
//		app = new router();
//		Backbone.history.start();
//	});
	//使用集合
	var appleData = [{name:"fuji", url:"img/fuji.jpg"}, {name:"gala", url:"img/gala.jpg"}];
	var Apples = Backbone.Collection.extend({});
	var router = Backbone.Router.extend({
		routes:{"":"home", "apples/:appleName":"loadApple"},
		initialize:function(){
			var apples = new Apples();
			apples.reset(appleData);//自动创建模型
			this.homeView = new homeView({collection:apples});
			this.appleView = new appleView({collection:apples});
		},
		home:function(){ this.homeView.render(); },
		loadApple:function(appleName){ this.appleView.loadApple(appleName); }
	});
	var homeView = Backbone.View.extend({
		el:"body",
		listEl:'.apples-list',
		cartEl:'.cart-box',
		template:_.template('Apple data: \
			<ul class="apples-list"></ul>\
			<div class="cart-box"></div>'),
		initialize:function(){
			this.$el.html(this.template);
			this.collection.on('addToCart', this.showCart, this);
		},
		showCart:function(appleModel){
			$(this.cartEl).append(appleModel.attributes.name + '<br/>');
		},
		render:function(){
			view = this;
			this.collection.each(function(apple){
				var appleSubView = new appleItemView({model:apple});
				appleSubView.render();
				$(view.listEl).append(appleSubView.$el);
			});
			//this.$el.html(this.template({data:JSON.stringify((this.collection.models))}));
		}
	});
	var appleView = Backbone.View.extend({
		initialize:function(){
			this.model = new (Backbone.Model.extend({}));//这里一定要加括号
			this.model.on("change", this.render, this);
			this.on("spinner", this.showSpinner, this);
		},
		template:_.template('<figure>\
								<img src="<%=attributes.url%>"/>\
								<figcaption><%=attributes.name%></figcaption>\
							</figure>'),
		templateSpinner:'<img src="img/loading.gif" width="30" />',
		loadApple:function(appleName){
			this.trigger("spinner");
			var view = this;//需要在闭包里访问view
			setTimeout(function(){
				view.model.set(view.collection.where({name:appleName})[0].attributes);
			}, 1000);
		},
		render:function(appleName){
			var appleHtml = this.template(this.model);
			$('body').html(appleHtml);
		},
		showSpinner:function(){ $('body').html(this.templateSpinner); }
	});
	var appleItemView = Backbone.View.extend({
		tagName:'li',
		template:_.template('<a href="#apples/<%=name%>" target="_blank"><%=name%></a>&nbsp;\
							<a class="add-to-cart" href="#">buy</a>'),
		events:{ 'click .add-to-cart':'addToCart'},
		render:function(){
			this.$el.html(this.template(this.model.attributes));
		},
		addToCart:function(){
			this.model.collection.trigger('addToCart', this.model);
		}
	});
	$(document).ready(function(){
		app = new router;
		Backbone.history.start();
	});
</script>
</html>
