<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
	<link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
	
	<script src="js/bmob-min.js"></script>
</head>
<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<h1>Chat with Bmob REST API</h1>
			<table class="table table-bordered table-striped">
				<caption>Message</caption>
				<thead><tr><th>Username</th><th>Message</th></tr></thead>
				<tbody><tr><td colspan="2">No messages</td></tr></tbody>
			</table>
		</div>
		<div class="row-fluid">
			<form id="new-user">
				<input type="text" name="username" placeholder="Username" />
				<input type="text" name="message" placeholder="Message" />
				<a id="send" class="btn btn-primary">SEND</a>
			</form>
		</div>
	</div>
</body>
<script>
//此处采用Bmob JS SDK方式
$(document).ready(function(){
	Bmob.initialize("b6216080026d5d0457b2d9cd7281d3b8", "34e67b5d8cb54442984ed38dfce84d85");
	
	getMessages();
	$("#send").click(function(){
		var username = $("input[name=username]").val();
		var message = $("input[name=message]").val();
		console.log("username: " + username + ", message: " + message);
		addMessage(username, message);
	});
	
	function addMessage(username, message){
		var MessageBoard = Bmob.Object.extend("MessageBoard");
		var messageBoard = new MessageBoard();
		messageBoard.save({"username":username, "message":message}, {
			success:function(object){
				alert("create object success, object id: " + object.id);
				getMessages();
			},
			error:function(object, error){ alert("create object fail"); }
		});
	}
	function getMessages(){
		var MessageBoard = Bmob.Object.extend("MessageBoard");
	    var query = new Bmob.Query(MessageBoard);
	    query.find({
	      success: function(results) {
	        alert("Get " + results.length + " messages.");
	        updateView(results);
	      },
	      error: function(object, error) { alert("query object fail"); }
    	});
	}
	
	function updateView(results){
		var tableBody = $(".table tbody");
		tableBody.html("");
		$.each(results, function(index, result) {
			var trEl = $("<tr><td>" + result.get("username") + "</td><td>" + result.get("message") + "</td></tr>");
			tableBody.append(trEl);
		});
	}
});

</script>
</html>
